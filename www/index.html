<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEC Êô∫ÊÖßË∑ØÂè£ÁõëÊéß</title>
    <link rel="icon" href="data:,">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: -apple-system, system-ui, sans-serif;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
        }
        h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .status {
            background: rgba(255,255,255,0.1);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 30px;
        }
        .status.online { color: #4ade80; }
        .status.offline { color: #f87171; }

        .main {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
        }

        .intersection {
            width: 400px;
            height: 400px;
            background: #0f172a;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .road-v {
            position: absolute;
            left: 50%; top: 0;
            transform: translateX(-50%);
            width: 100px; height: 100%;
            background: #334155;
        }
        .road-h {
            position: absolute;
            top: 50%; left: 0;
            transform: translateY(-50%);
            width: 100%; height: 100px;
            background: #334155;
        }

        .tl {
            position: absolute;
            background: #000;
            border-radius: 10px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .tl-ns-top { top: 20px; right: 60px; }
        .tl-ns-bot { bottom: 20px; left: 60px; }
        .tl-ew-right { right: 20px; bottom: 60px; flex-direction: row; }
        .tl-ew-left { left: 20px; top: 60px; flex-direction: row; }

        .bulb {
            width: 22px; height: 22px;
            border-radius: 50%;
            background: #222;
            transition: all 0.3s;
        }
        .bulb.red.on { background: #ef4444; box-shadow: 0 0 20px #ef4444; }
        .bulb.yellow.on { background: #eab308; box-shadow: 0 0 20px #eab308; }
        .bulb.green.on { background: #22c55e; box-shadow: 0 0 20px #22c55e; }

        .timer {
            position: absolute;
            font-family: monospace;
            font-size: 1.8rem;
            font-weight: bold;
            text-shadow: 0 0 10px currentColor;
        }
        .timer-ns { top: 30px; right: 15px; }
        .timer-ew { right: 25px; bottom: 15px; }
        .timer.red { color: #ef4444; }
        .timer.yellow { color: #eab308; }
        .timer.green { color: #22c55e; }

        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            width: 280px;
        }
        .panel h2 {
            font-size: 1rem;
            color: #94a3b8;
            margin-bottom: 15px;
            border-left: 3px solid #7b2ff7;
            padding-left: 10px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .info-label { color: #94a3b8; }
        .info-value { font-weight: bold; font-family: monospace; }
        .info-value.red { color: #ef4444; }
        .info-value.yellow { color: #eab308; }
        .info-value.green { color: #22c55e; }

        .logs {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.75rem;
            font-family: monospace;
        }
        .logs div { color: #4ade80; padding: 2px 0; }
    </style>
</head>
<body>
    <h1>üö¶ Êô∫ÊÖßË∑ØÂè£ÁõëÊéß‰∏≠ÂøÉ</h1>
    <div class="status offline" id="status">‚óè ËøûÊé•‰∏≠...</div>

    <div class="main">
        <div class="intersection">
            <div class="road-v"></div>
            <div class="road-h"></div>

            <div class="tl tl-ns-top" id="tl-ns-1">
                <div class="bulb red"></div>
                <div class="bulb yellow"></div>
                <div class="bulb green"></div>
            </div>
            <div class="tl tl-ns-bot" id="tl-ns-2">
                <div class="bulb red"></div>
                <div class="bulb yellow"></div>
                <div class="bulb green"></div>
            </div>
            <div class="timer timer-ns red" id="timer-ns">--</div>

            <div class="tl tl-ew-right" id="tl-ew-1">
                <div class="bulb red"></div>
                <div class="bulb yellow"></div>
                <div class="bulb green"></div>
            </div>
            <div class="tl tl-ew-left" id="tl-ew-2">
                <div class="bulb red"></div>
                <div class="bulb yellow"></div>
                <div class="bulb green"></div>
            </div>
            <div class="timer timer-ew green" id="timer-ew">--</div>
        </div>

        <div class="panel">
            <h2>‰ø°Âè∑Áä∂ÊÄÅ</h2>
            <div class="info-row">
                <span class="info-label">ÂçóÂåóÊñπÂêë</span>
                <span class="info-value" id="ns-info">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">‰∏úË•øÊñπÂêë</span>
                <span class="info-value" id="ew-info">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">Ê∂àÊÅØÊï∞</span>
                <span class="info-value" id="msg-count">0</span>
            </div>
            <div class="info-row">
                <span class="info-label">Êï∞ÊçÆÊ∫ê</span>
                <span class="info-value" id="data-source">--</span>
            </div>
            <h2 style="margin-top:20px">Êó•Âøó</h2>
            <div class="logs" id="logs"></div>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');
        const msgCountEl = document.getElementById('msg-count');
        const dataSourceEl = document.getElementById('data-source');
        
        let msgCount = 0;
        let ws = null;
        let wsConnected = false;
        
        // Êú¨Âú∞Ê®°ÊãüÁä∂ÊÄÅÔºàÂΩìWebSocketÊñ≠ÂºÄÊó∂‰ΩøÁî®Ôºâ
        let localState = {
            ns: { color: 'green', timer: 30 },
            ew: { color: 'red', timer: 33 }
        };

        function log(msg) {
            const d = document.createElement('div');
            d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logsEl.appendChild(d);
            logsEl.scrollTop = logsEl.scrollHeight;
            if (logsEl.children.length > 30) logsEl.removeChild(logsEl.firstChild);
        }

        function setLight(prefix, color) {
            ['1','2'].forEach(n => {
                const el = document.getElementById(`tl-${prefix}-${n}`);
                if (!el) return;
                el.querySelectorAll('.bulb').forEach(b => b.classList.remove('on'));
                const bulb = el.querySelector(`.bulb.${color}`);
                if (bulb) bulb.classList.add('on');
            });
        }

        function updateUI(ns, ew, source) {
            if (!ns || !ew) return;
            
            setLight('ns', ns.color);
            setLight('ew', ew.color);
            
            const timerNs = document.getElementById('timer-ns');
            const timerEw = document.getElementById('timer-ew');
            
            timerNs.textContent = String(ns.timer).padStart(2, '0');
            timerEw.textContent = String(ew.timer).padStart(2, '0');
            timerNs.className = `timer timer-ns ${ns.color}`;
            timerEw.className = `timer timer-ew ${ew.color}`;
            
            const names = {red:'Á∫¢ÁÅØ', yellow:'ÈªÑÁÅØ', green:'ÁªøÁÅØ'};
            document.getElementById('ns-info').textContent = `${names[ns.color]} ${ns.timer}s`;
            document.getElementById('ns-info').className = `info-value ${ns.color}`;
            document.getElementById('ew-info').textContent = `${names[ew.color]} ${ew.timer}s`;
            document.getElementById('ew-info').className = `info-value ${ew.color}`;
            
            dataSourceEl.textContent = source;
            dataSourceEl.className = source === 'WS' ? 'info-value green' : 'info-value yellow';
        }

        // Êú¨Âú∞ÂÄíËÆ°Êó∂Ê®°Êãü
        function tickLocal() {
            localState.ns.timer--;
            if (localState.ns.timer <= 0) {
                if (localState.ns.color === 'green') { localState.ns.color = 'yellow'; localState.ns.timer = 3; }
                else if (localState.ns.color === 'yellow') { localState.ns.color = 'red'; localState.ns.timer = 30; }
                else { localState.ns.color = 'green'; localState.ns.timer = 30; }
            }
            localState.ew.timer--;
            if (localState.ew.timer <= 0) {
                if (localState.ew.color === 'red') { localState.ew.color = 'green'; localState.ew.timer = 30; }
                else if (localState.ew.color === 'green') { localState.ew.color = 'yellow'; localState.ew.timer = 3; }
                else { localState.ew.color = 'red'; localState.ew.timer = 30; }
            }
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) return;
            
            try {
                ws = new WebSocket(`ws://${location.host}`, 'traffic-protocol');
                
                ws.onopen = () => {
                    wsConnected = true;
                    statusEl.textContent = '‚óè Â∑≤ËøûÊé• (WebSocket)';
                    statusEl.className = 'status online';
                    log('WebSocket ËøûÊé•ÊàêÂäü');
                };
                
                ws.onclose = () => {
                    wsConnected = false;
                    statusEl.textContent = '‚óè Êú¨Âú∞Ê®°Âºè';
                    statusEl.className = 'status offline';
                    log('WebSocket Êñ≠ÂºÄÔºå‰ΩøÁî®Êú¨Âú∞Ê®°Êãü');
                    setTimeout(connect, 3000);
                };
                
                ws.onerror = () => {
                    wsConnected = false;
                };
                
                ws.onmessage = (e) => {
                    msgCount++;
                    msgCountEl.textContent = msgCount;
                    try {
                        const data = JSON.parse(e.data);
                        if (data.type === 'traffic_update') {
                            // ÂêåÊ≠•Êú¨Âú∞Áä∂ÊÄÅ
                            localState.ns = { ...data.ns };
                            localState.ew = { ...data.ew };
                            updateUI(data.ns, data.ew, 'WS');
                        }
                    } catch(err) { 
                        console.error('Parse error:', err); 
                    }
                };
            } catch(e) {
                log('ËøûÊé•Â§±Ë¥•: ' + e.message);
            }
        }

        // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
        setInterval(() => {
            if (!wsConnected) {
                // WebSocket Êñ≠ÂºÄÊó∂‰ΩøÁî®Êú¨Âú∞Ê®°Êãü
                tickLocal();
                updateUI(localState.ns, localState.ew, 'Êú¨Âú∞');
            }
        }, 1000);

        log('Á≥ªÁªüÂêØÂä®...');
        connect();
    </script>
</body>
</html>

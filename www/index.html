<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEC Êô∫ÊÖßË∑ØÂè£ÁõëÊéß</title>
    <link rel="icon" href="data:,">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: -apple-system, system-ui, sans-serif;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
        }
        h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, #00d4ff, #7b2ff7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .status {
            background: rgba(255,255,255,0.1);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 30px;
        }
        .status.online { color: #4ade80; }
        .status.offline { color: #f87171; }

        .main {
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
        }

        /* Ë∑ØÂè£ËßÜÂõæ */
        .intersection {
            width: 400px;
            height: 400px;
            background: #0f172a;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .road-v {
            position: absolute;
            left: 50%; top: 0;
            transform: translateX(-50%);
            width: 100px; height: 100%;
            background: #334155;
            border-left: 2px dashed rgba(255,255,255,0.3);
            border-right: 2px dashed rgba(255,255,255,0.3);
        }
        .road-h {
            position: absolute;
            top: 50%; left: 0;
            transform: translateY(-50%);
            width: 100%; height: 100px;
            background: #334155;
            border-top: 2px dashed rgba(255,255,255,0.3);
            border-bottom: 2px dashed rgba(255,255,255,0.3);
        }
        .center-line-v {
            position: absolute;
            left: 50%; top: 0;
            transform: translateX(-50%);
            width: 2px; height: 100%;
            background: repeating-linear-gradient(180deg, transparent 0, transparent 15px, #fbbf24 15px, #fbbf24 30px);
        }
        .center-line-h {
            position: absolute;
            top: 50%; left: 0;
            transform: translateY(-50%);
            height: 2px; width: 100%;
            background: repeating-linear-gradient(90deg, transparent 0, transparent 15px, #fbbf24 15px, #fbbf24 30px);
        }

        /* Á∫¢ÁªøÁÅØ */
        .tl {
            position: absolute;
            background: #000;
            border-radius: 10px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .tl-ns-top { top: 20px; right: 60px; }
        .tl-ns-bot { bottom: 20px; left: 60px; }
        .tl-ew-right { right: 20px; bottom: 60px; flex-direction: row; }
        .tl-ew-left { left: 20px; top: 60px; flex-direction: row; }

        .bulb {
            width: 22px; height: 22px;
            border-radius: 50%;
            background: #222;
            transition: all 0.3s;
        }
        .bulb.red.on { background: #ef4444; box-shadow: 0 0 20px #ef4444; }
        .bulb.yellow.on { background: #eab308; box-shadow: 0 0 20px #eab308; }
        .bulb.green.on { background: #22c55e; box-shadow: 0 0 20px #22c55e; }

        .timer {
            position: absolute;
            font-family: monospace;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 0 10px currentColor;
        }
        .timer-ns { top: 30px; right: 20px; }
        .timer-ew { right: 30px; bottom: 20px; }

        /* ‰æßÊ†è */
        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            width: 280px;
        }
        .panel h2 {
            font-size: 1rem;
            color: #94a3b8;
            margin-bottom: 15px;
            border-left: 3px solid #7b2ff7;
            padding-left: 10px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #94a3b8; }
        .info-value { font-weight: bold; font-family: monospace; }
        .info-value.red { color: #ef4444; }
        .info-value.yellow { color: #eab308; }
        .info-value.green { color: #22c55e; }

        .logs {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
            font-family: monospace;
        }
        .logs div { color: #4ade80; padding: 3px 0; }
    </style>
</head>
<body>
    <h1>üö¶ Êô∫ÊÖßË∑ØÂè£ÁõëÊéß‰∏≠ÂøÉ</h1>
    <div class="status offline" id="status">‚óè Á≠âÂæÖËøûÊé•...</div>

    <div class="main">
        <div class="intersection">
            <div class="road-v"></div>
            <div class="road-h"></div>
            <div class="center-line-v"></div>
            <div class="center-line-h"></div>

            <!-- ÂçóÂåóÂêëÁÅØ -->
            <div class="tl tl-ns-top" id="tl-ns-1">
                <div class="bulb red"></div>
                <div class="bulb yellow"></div>
                <div class="bulb green"></div>
            </div>
            <div class="tl tl-ns-bot" id="tl-ns-2">
                <div class="bulb red"></div>
                <div class="bulb yellow"></div>
                <div class="bulb green"></div>
            </div>
            <div class="timer timer-ns" id="timer-ns">--</div>

            <!-- ‰∏úË•øÂêëÁÅØ -->
            <div class="tl tl-ew-right" id="tl-ew-1">
                <div class="bulb red"></div>
                <div class="bulb yellow"></div>
                <div class="bulb green"></div>
            </div>
            <div class="tl tl-ew-left" id="tl-ew-2">
                <div class="bulb red"></div>
                <div class="bulb yellow"></div>
                <div class="bulb green"></div>
            </div>
            <div class="timer timer-ew" id="timer-ew">--</div>
        </div>

        <div class="panel">
            <h2>‰ø°Âè∑Áä∂ÊÄÅ</h2>
            <div class="info-row">
                <span class="info-label">ÂçóÂåóÊñπÂêë</span>
                <span class="info-value" id="ns-info">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">‰∏úË•øÊñπÂêë</span>
                <span class="info-value" id="ew-info">--</span>
            </div>
            <div class="info-row">
                <span class="info-label">Ê∂àÊÅØÊï∞</span>
                <span class="info-value" id="msg-count">0</span>
            </div>
            <h2 style="margin-top:20px">Êó•Âøó</h2>
            <div class="logs" id="logs"></div>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const logsEl = document.getElementById('logs');
        const msgCountEl = document.getElementById('msg-count');
        let msgCount = 0;

        function log(msg) {
            const d = document.createElement('div');
            d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logsEl.appendChild(d);
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        function setLight(prefix, color) {
            ['1','2'].forEach(n => {
                const el = document.getElementById(`tl-${prefix}-${n}`);
                if (!el) return;
                el.querySelectorAll('.bulb').forEach(b => b.classList.remove('on'));
                const bulb = el.querySelector(`.bulb.${color}`);
                if (bulb) bulb.classList.add('on');
            });
        }

        function update(data) {
            if (!data.ns || !data.ew) return;
            
            setLight('ns', data.ns.color);
            setLight('ew', data.ew.color);
            
            const timerNs = document.getElementById('timer-ns');
            const timerEw = document.getElementById('timer-ew');
            timerNs.textContent = String(data.ns.timer).padStart(2,'0');
            timerEw.textContent = String(data.ew.timer).padStart(2,'0');
            timerNs.style.color = `var(--${data.ns.color})`;
            timerEw.style.color = `var(--${data.ew.color})`;
            
            const colors = {red:'#ef4444', yellow:'#eab308', green:'#22c55e'};
            timerNs.style.color = colors[data.ns.color];
            timerEw.style.color = colors[data.ew.color];
            
            const names = {red:'Á∫¢ÁÅØ', yellow:'ÈªÑÁÅØ', green:'ÁªøÁÅØ'};
            document.getElementById('ns-info').textContent = `${names[data.ns.color]} ${data.ns.timer}s`;
            document.getElementById('ns-info').className = `info-value ${data.ns.color}`;
            document.getElementById('ew-info').textContent = `${names[data.ew.color]} ${data.ew.timer}s`;
            document.getElementById('ew-info').className = `info-value ${data.ew.color}`;
        }

        function connect() {
            const ws = new WebSocket(`ws://${location.host}`, 'traffic-protocol');
            
            ws.onopen = () => {
                statusEl.textContent = '‚óè Â∑≤ËøûÊé•';
                statusEl.className = 'status online';
                log('WebSocket ËøûÊé•ÊàêÂäü');
            };
            
            ws.onclose = () => {
                statusEl.textContent = '‚óè Â∑≤Êñ≠ÂºÄ';
                statusEl.className = 'status offline';
                log('ËøûÊé•Êñ≠ÂºÄÔºå3ÁßíÂêéÈáçËøû');
                setTimeout(connect, 3000);
            };
            
            ws.onerror = (e) => log('ËøûÊé•ÈîôËØØ');
            
            ws.onmessage = (e) => {
                msgCount++;
                msgCountEl.textContent = msgCount;
                try {
                    const data = JSON.parse(e.data);
                    if (data.type === 'traffic_update') update(data);
                } catch(err) { console.error(err); }
            };
        }

        log('ÂàùÂßãÂåñ...');
        connect();
    </script>
</body>
</html>
